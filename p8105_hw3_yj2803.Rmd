---
title: "Homework 3"
author: "Yuki Joyama"
date: "2023-10-05"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, message = FALSE)

library(tidyverse)
```

# Problem 1

**Data import setup**
```{r}
library(p8105.datasets)
data("instacart") # call instacart data from the library 
```

The instacart data has `r nrow(instacart)` rows and `r ncol(instacart)` columns. Some key variables include order_id, product_id, user_id, product_name, etc.

**Examples of observations in instacart dataset**
```{r}
head(instacart, n = 8) |> 
  knitr::kable(digits = 1) # include table in the md file
```

The above example shows detailed information about `order_id` = 1. As we can see from the table, `order_id` is tied to specific IDs which identify product, user, aisle and department. From `product_name`, we can tell what the user got for this order. `order_number` = 4 means that this was the 4th order from this customer. `order_dow`, `order_hour_of_day`, and `days_since_prior` tell us that this order was placed on the 4th week, between 10 am to 11 am, and 9 days since the last order. `reordered` is recorded as 1 if the product has been ordered by this user in the past, and 0 otherwise. 

```{r}
# summarize aisle data
df_aisles <- instacart |> 
  group_by(aisle_id, aisle) |> 
  summarise(count = n())  # count how many times aisle_id were recorded in the dataset for each id (= the number of items ordered from each aisle)

max_aisle <- max(pull(df_aisles, count)) # check maximum count of aisles

df_aisles_max <- df_aisles |> 
  filter(count == max_aisle) # filter by the maximum count of aisles
```

`r max(pull(instacart, aisle_id))` aisles are in this dataset, and **`r pull(df_aisles_max, aisle)`** are the most items (in total `r max_aisle` items) ordered from.

The following plot shows the number of items ordered in each aisle, limiting this to aisles with more than 10000 items ordered.
```{r}
# make a plot (the number of items ordered in each aisle)
df_aisles |> 
  filter(count > 10000) |> # just show aisles with more than 10000 items 
  ggplot(aes(x = reorder(aisle, count), y = count)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    title = "Items by aisle",
    x = "Aisle",
    y = "Item count",
    caption = "Only showing aisles with more than 10000 items ordered; sorted in an ascending order"
  )
```

**Popular items in "baking ingredients"**
```{r}
# table showing the three most popular items in "baking ingredients"
df_baking_ingredients <- instacart |> 
  filter(aisle == c("baking ingredients")) |> # filter by aisle
  group_by(product_name) |> 
  summarise(count = n()) |> # add count for each item
  arrange(desc(count)) |> # arrange in descending order
  head(n = 3) # only show the first three items
  
df_baking_ingredients |> 
  knitr::kable(digits = 1) # show table in md file 
```
The three most popular items in "baking ingredients" are `r pull(df_baking_ingredients, product_name)`.

**Popular items in "dog food care"**
```{r}
# table showing the three most popular items in "dog food care"
df_dog_food_care <- instacart |> 
  filter(aisle == c("dog food care")) |> # filter by aisle
  group_by(product_name) |> 
  summarise(count = n()) |> # add count for each item
  arrange(desc(count)) |> # arrange in descending order
  head(n = 3) # only show the first three items
  
df_dog_food_care |> 
  knitr::kable(digits = 1) # show table in md file 
```
The three most popular items in "dog food care" are `r pull(df_dog_food_care, product_name)`.

**Popular items in "packaged vegetables fruits"**
```{r}
# table showing the three most popular items in "packaged vegetables fruits"
df_packaged_vegetables_fruits <- instacart |> 
  filter(aisle == c("packaged vegetables fruits")) |> # filter by aisle
  group_by(product_name) |> 
  summarise(count = n()) |> # add count for each item
  arrange(desc(count)) |> # arrange in descending order
  head(n = 3) # only show the first three items
  
df_packaged_vegetables_fruits |> 
  knitr::kable(digits = 1) # show table in md file 
```
The three most popular items in "packaged vegetables fruits" are `r pull(df_packaged_vegetables_fruits, product_name)`.

The table below provides the mean order time for Pink Lady Apples and Coffee Ice Cream on each day of the week:

**Pink Lady Apples**
```{r warning = FALSE}
# Pink Lady Apples and Coffee Ice Cream table
pink_lady_apples <- instacart |> 
  filter(product_name == c("Pink Lady Apples")) |> # filter by product name
  select(-product_name) |> 
  group_by(order_dow) |> 
  summarise("mean_hour" = mean(order_hour_of_day)) # show the mean hour of the day on each day of the week

pink_lady_apples |> 
  knitr::kable(digits = 1) # show table in md file 
```

**Coffee Ice Cream**
```{r warning = FALSE}
# Pink Lady Apples and Coffee Ice Cream table
coffee_ice_cream <- instacart |> 
  filter(product_name == c("Coffee Ice Cream")) |> # filter by product name
  select(-product_name) |> 
  group_by(order_dow) |> 
  summarise("mean_hour" = mean(order_hour_of_day)) # show the mean hour of the day on each day of the week


coffee_ice_cream |> 
  knitr::kable(digits = 1) # show table in md file 
```

# Problem 2

**Data import setup**
```{r}
library(p8105.datasets)
data("brfss_smart2010") # call BRFSS data from the library 
```

**Data cleaning**
```{r warning = F}
df_brfss_cleaned <- brfss_smart2010 |> 
  janitor::clean_names() |> 
  filter(topic == "Overall Health" & response %in% c("Excellent", "Very good", "Good", "Fair", "Poor")) |>  # focus on Overall Health; only include responses from "Excellent" to "Poor"
  mutate(
    response = factor(response, levels = c("Poor", "Fair", "Good", "Very good", "Excellent")) # change response as factor taking levels ordered from “Poor” to “Excellent”
  )
```

- In 2002, which states were observed at 7 or more locations? What about in 2010?

```{r}
# check 2002
df_brfss_2002 <- df_brfss_cleaned |> 
  filter(year == 2002) |>  # filter by year 
  group_by(locationabbr) |> # group by states
  summarise(count = n() / 5) |> # count number of observations in each state
  filter(count >= 7) # show states which have >= 7 locations

# check 2010
df_brfss_2010 <- df_brfss_cleaned |> 
  filter(year == 2010) |>  # filter by year 
  group_by(locationabbr) |> # group by states
  summarise(count = n() / 5) |> # count number of observations in each state
  filter(count >= 7) # show states which have >= 7 locations
```

7 or more locations were observed in `r pull(df_brfss_2002, locationabbr)` in 2002; `r pull(df_brfss_2010, locationabbr)` in 2010.

- Construct a dataset that is limited to `Excellent` responses, and contains, year, state, and a variable that averages the `data_value` across locations within a state. Make a “spaghetti” plot of this average value over time within a state (that is, make a plot showing a line for each state across years).

```{r fig.width = 12, fig.height = 6}
# create a dataset that is limited to "Excellent" responses
df_brfss_excellent <- df_brfss_cleaned |> 
  filter(response == "Excellent") |> # filter by response "Excellent"
  select(year, locationabbr, data_value) |> # only include necessary variables in the dataset
  group_by(locationabbr, year) |> 
  drop_na() |> # drop the missing values so that we can calculate mean value
  summarise(value_mean = mean(data_value)) # calculate mean data_value across locations within a state

# create a spaghetti plot with x being year, y being the value_mean
df_brfss_excellent |> 
  rename("state" = locationabbr) |> # renamed column for plot output
  ggplot(aes(x = year, y = value_mean, group = state, color = state)) + 
  geom_point() + # spaghetti plot
  geom_line() +
  theme(legend.text = element_text(size = 6)) + # changed legend text size
  guides(color = guide_legend(ncol = 3)) + # changed the number of legend columns
  labs(
    title = "The average value over time within a state",
    x = "Year",
    y = "The average value",
    caption = "Only showing data with Excellent response"
  )
```

- Make a two-panel plot showing, for the years 2006, and 2010, distribution of `data_value` for responses (“Poor” to “Excellent”) among locations in NY State.

```{r fig.width = 12, fig.height = 6}
library(patchwork) # to create a two-panel plot

# prepare a dataset for plot
df_ny_2006 <- df_brfss_cleaned |> 
  filter(locationabbr == "NY" & year == 2006)  # only include 2006 data in NY
  
df_ny_2010 <- df_brfss_cleaned |> 
  filter(locationabbr == "NY" & year == 2010)  # only include 2006 data in NY
  
# plot for 2006
p_ny_2006 = df_ny_2006 |> 
  ggplot(aes(x = locationdesc, y = data_value)) +
  geom_violin(aes(fill = locationdesc), color = "blue", alpha = .5) +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + # change the legend location
  labs(
    title = "2006",
    x = "Location",
  )  

# plot for 2010
p_ny_2010 = df_ny_2010 |> 
  ggplot(aes(x = locationdesc, y = data_value, fill = response)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + # change the legend location
  labs(
    title = "2010",
    x = "Location",
  ) 

p_ny_2006 + p_ny_2010 # put two plots side by side
```










